<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.home.estate.mapper.EstateMapper">

	<resultMap type="aptTradeInfoDto" id="aptInfo">
		<result column="apartmentName" property="aptName" />
		<result column="aptCode" property="aptCode" />
		<result column="buildYear" property="buildYear" />
		<result column="dongCode" property="dongCode" />
		<result column="lng" property="lng" />
		<result column="lat" property="lat" />
		<result column="dong" property="dong" />
		<result column="dealAmount" property="price" />
		<result column="dealYear" property="dealYear" />
		<result column="dealMonth" property="dealMonth" />
		<result column="dealDay" property="dealDay" />
		<result column="area" property="area" />
		<result column="floor" property="floor" />
	</resultMap>

	<resultMap type="dongCode" id="dongCodeInfo">

	</resultMap>

	<select id="getAptListByOption" parameterType="map"
		resultMap="aptInfo">
		select hi.apartmentName, hi.aptCode, hi.buildYear, hi.dongCode,
		hi.lng, hi.lat, hi.dong, hd.dealAmount, hd.dealYear, hd.dealMonth,
		hd.dealDay, hd.area, hd.floor
		from (
		select *
		from houseinfo
		<where>
			dongCode in
			(
			select dongCode
			from dongcode
			<where>
				<choose>
					<when test="dong != null">
						dongName = #{dong}
					</when>
					<when test="gugun != null">
						gugunName = #{gugun}
					</when>
					<when test="si != null">
						sidoName = #{si}
					</when>
					<otherwise>
					</otherwise>
				</choose>
			</where>
			)
			<if test="keyword != null">
				and apartmentName like concat('%', #{keyword}, '%')
			</if>
		</where>
		) hi join
		(
		select *
		from housedeal
		<where>
			<!-- <choose>
				<when test="startyear != null && endyear != null">
					dealYear between #{startyear} and #{endyear}
				</when>
				<when test="startyear" != null>
				
				</when>
			</choose> -->
			<if test="startyear != null">
				and dealYear >= #{startyear}
			</if>
			<if test="startmonth != null">
				and dealmonth >= #{startmonth}
			</if>
				<if test="endyear != null">
					and dealYear<![CDATA[<]]>=#{endyear}
				</if>
				<if test="endmonth != null">
					and dealmonth<![CDATA[<]]>=#{endmonth}
				</if>
		</where>
		) hd on (hi.aptCode = hd.aptCode)

	</select>

	<select id="getSiList" resultType="string">
		select distinct sidoName
		from
		dongcode;
	</select>

	<select id="getGuGunList" resultType="string">
		select distinct gugunName
		from dongcode
		where gugunName is not null and sidoName like concat('%',
		#{si}, '%')
	</select>

	<select id="getDongList" parameterType="map" resultType="string">
		select dongName
		from dongcode
		where dongName is not null and gugunName =
		#{gugun} and sidoName = #{si}
		<!-- <include refid="search"></include> -->
	</select>

	<select id="getInterestLocation" parameterType="string"
		resultMap="dongCodeInfo">
		select * from dongcode where dongCode in
		(
		SELECT dongCode
		FROM interest
		where user_id = #{userId}
		);

	</select>
	<!-- <sql id="search"> <if test="dong != null"> and gugunName like concat('%', 
		#{gugun}, '%') and gugunName = #{gugun} </if> <if test="si != null"> and 
		sidoName like concat('%', #{si}, '%') and sidoName = #{si} </if> </sql> -->
</mapper>